#!/bin/bash
# Minimal transcription script using whisper-cli with diarization and transcript cleaning.


set -euo pipefail
IFS=$'\n\t'

# Get the directory where the script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
CLEANER_SCRIPT="${SCRIPT_DIR}/clean-transcript.py"

# Set the path to the Whisper model
MODEL_PATH="/Users/jim/work/whisper.cpp/models/ggml-small.en-tdrz.bin"

# Check dependencies
for cmd in yt-dlp ffmpeg whisper-cli python; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo "Error: $cmd is not installed." >&2
        echo "Please install missing dependencies:"
        echo "  yt-dlp: pip install yt-dlp"
        echo "  ffmpeg: brew install ffmpeg (macOS) or apt install ffmpeg (Linux)"
        echo "  whisper-cli: Follow installation instructions at https://github.com/ggerganov/whisper.cpp"
        exit 1
    fi
done

# Usage: $0 <input_file_or_url>
if [[ $# -lt 1 ]]; then
    echo "Usage: $0 <input_file_or_url>" >&2
    exit 1
fi

INPUT="$1"

# Use an environment variable for duration
: "${DURATION:=}"
FFMPEG_DURATION_ARG=""
if [[ -n "$DURATION" ]]; then
    FFMPEG_DURATION_ARG="-t $DURATION"
fi

# If input is a URL, download audio
if [[ "$INPUT" =~ ^https?:// ]]; then
    echo "Downloading audio from URL..."
    yt-dlp -f bestaudio --output "downloaded.%(ext)s" "$INPUT"
    INPUT=$(ls downloaded.* | head -n 1)
    if [[ -z "$INPUT" ]]; then
        echo "Error: Audio download failed." >&2
        exit 1
    fi
fi

# Determine input file type based on extension
EXT="${INPUT##*.}"
if [[ "$EXT" == "vtt" || "$EXT" == "out" ]]; then
    TRANSCRIPT_FILE="${INPUT%.*}_cleaned.txt"
    echo "Input file is VTT or .out; skipping conversion and transcription."
    echo "Cleaning transcript..."
    # Pass content through stdin and redirect output to file
    filename="$INPUT" python "$CLEANER_SCRIPT" < "$INPUT" > "$TRANSCRIPT_FILE"
    echo "Transcript available at: $TRANSCRIPT_FILE"
    exit 0
elif [[ "$EXT" != "wav" ]]; then
    WAV_FILE="${INPUT%.*}.wav"
    echo "Converting $INPUT to WAV..."
    ffmpeg -y -i "$INPUT" $FFMPEG_DURATION_ARG -ar 16000 -c:a pcm_s16le "$WAV_FILE"
else
    WAV_FILE="$INPUT"
fi

# Run Whisper transcription with diarization
TRANSCRIPT_FILE="${WAV_FILE%.*}.txt"
echo "Running Whisper transcription..."
echo "Using model: $MODEL_PATH"
echo "This may take a while depending on the length of the audio..."
whisper-cli -tdrz -m "$MODEL_PATH" "$WAV_FILE" | tee "$TRANSCRIPT_FILE"

# Clean the transcript
echo "Cleaning transcript..."
filename="$TRANSCRIPT_FILE" python "$CLEANER_SCRIPT" < "$TRANSCRIPT_FILE" > "${TRANSCRIPT_FILE}.clean"
mv "${TRANSCRIPT_FILE}.clean" "$TRANSCRIPT_FILE"

# Create a backup of the original transcript
cp "$TRANSCRIPT_FILE" "${TRANSCRIPT_FILE}.original"

echo "Transcript available at: $TRANSCRIPT_FILE"
echo "Original transcript backed up at: ${TRANSCRIPT_FILE}.original"

# Cleanup temporary WAV file if conversion was done
if [[ "$EXT" != "wav" ]]; then
    echo "Cleaning up temporary file: $WAV_FILE" >&2
    rm -f "$WAV_FILE"
fi
